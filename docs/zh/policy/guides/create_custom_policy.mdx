---
title: 创建自定义策略
description: 了解如何在 Alauda 容器安全中创建自定义策略。
weight: 20
sourceSHA: 8be3d3d3c7898402e6e014958b233072203c9a33412eff5593ee5db76bde1b6b
---

# 在 Alauda 容器安全中创建自定义策略

Alauda 容器安全允许您创建自定义安全策略，除了使用默认策略外。您可以通过 Web 门户或使用 Kubernetes 自定义资源（CR）以代码形式创建和管理策略。

## 创建自定义策略的方法

- 在 Alauda 容器安全门户中，转到 **平台配置 > 策略管理**，然后单击 **创建策略**。
- 在 **风险** 部分，使用过滤器选择标准，然后单击 **创建策略**。
- 通过将策略保存为 Kubernetes CR 并使用 Argo CD 等工具将其应用于集群，以代码形式管理策略。

## 通过门户创建策略

### 1. 输入策略详细信息

- **名称**：输入策略的名称。
- **严重性**：选择严重性级别。
- **类别**：选择策略类别（必填）。
- **描述**：提供有关策略的详细信息。
- **理由**：解释该策略的原因。
- **指导**：添加解决违规的步骤。
- **MITRE ATT\&CK**：选择相关的战术和技术。

### 2. 配置策略生命周期

- 选择适用的 **生命周期阶段**：**构建**、**部署**或 **运行时**。
- 对于 **运行时**，选择 **事件源**：**部署**或 **审计日志**。

### 3. 定义策略规则和标准

- 在 **规则** 部分，设置触发策略的条件。
- 拖放策略字段以构建规则。可用字段取决于所选的生命周期阶段。
- 使用逻辑运算符（**AND**/**OR**）组合多个值或规则。

### 4. 设置策略范围

- **包含范围**：将策略限制为特定集群、命名空间或部署标签。支持命名空间和标签的 RE2 正则表达式。
- **排除范围**：排除特定的部署、集群、命名空间或标签。命名空间和标签支持正则表达式（部署不支持）。
- 对于 **构建** 阶段，您可以从策略中排除镜像。

### 5. 配置策略操作

- **激活状态**：将策略设置为激活或未激活。
- **执行**：
  - **通知**：仅报告违规。
  - **通知并执行**：根据生命周期阶段执行操作：
    - **构建**：对不合规镜像失败 CI 构建。
    - **部署**：如果启用了准入控制器，则阻止或编辑不合规的部署。
    - **运行时**：删除符合策略标准的 Pod。
- **通知者**：附加通知者以将警报发送到电子邮件或外部工具（例如 Jira、Splunk、Webhooks）。通知者必须在 **平台配置 > 集成** 中预先配置。

### 6. 审核并保存策略

- 审核所有设置并预览潜在的违规。
- 单击 **保存** 以创建策略。

## 以代码形式创建和管理策略

> **注意：** 以代码形式的策略是技术预览功能，不建议在生产环境中使用。

### 先决条件

- Alauda 容器安全版本 4.6 或更高版本。
- 如果通过清单（roxctl）方法安装，请手动应用 `config.stackrox.io` CRD：

```bash
kubectl create -f helm/chart/crds/config.stackrox.io_securitypolicies.yaml
```

### 以代码形式创建策略的步骤

1. 在 **策略管理** 中，创建或克隆策略。
2. 在策略列表中，单击溢出菜单并选择 **保存为自定义资源**。对于多个策略，使用 **批量操作 > 保存为自定义资源**。
3. 根据需要编辑保存的 CR。
4. 将 CR 应用到安装 Central 的命名空间：

```bash
kubectl apply -f <your-policy-cr>.yaml -n stackrox
```

或者使用 Argo CD 或您的 GitOps 工具推送 CR。

#### 示例策略 CR

```yaml
kind: SecurityPolicy
apiVersion: config.stackrox.io/v1alpha1
metadata:
  name: short-name
spec:
  policyName: A longer form name
# ...
```

使用 `kubectl explain securitypolicy.spec` 获取字段详细信息。

## 编辑和管理策略

- 要编辑策略，请转到 **平台配置 > 策略管理**，选择策略，然后单击 **操作 > 编辑策略**。
- 默认策略无法直接编辑；请先克隆它们。

## 禁用以代码形式的策略

- **Operator 安装**：将 `spec.configAsCode.configAsCodeComponent` 设置为 `Disabled`。
- **Helm 安装**：在 `values.yaml` 中将 `configAsCode.enabled` 设置为 `false`。
- **清单（roxctl）安装**：删除 `config-controller` 部署：

```bash
kubectl -n stackrox delete deployment config-controller
```

## 其他说明

- 如果在门户和外部同时编辑策略，可能会发生策略漂移。漂移将在十小时内自动解决。
- 有关策略标准和生命周期阶段的更多信息，请参阅官方文档。
