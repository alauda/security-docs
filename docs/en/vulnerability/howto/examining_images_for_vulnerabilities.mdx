# Examining Images for Vulnerabilities

---

Alauda Container Security for Kubernetes allows you to analyze images for vulnerabilities using its built-in scanners. You can also [integrate with other supported scanners](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html-single/integrating/#integrate-with-image-vulnerability-scanners) as needed.

The scanners inspect each image layer, identify packages, and match them against known vulnerabilities. The vulnerability database is populated from multiple sources, including the National Vulnerability Database (NVD), Open Source Vulnerabilities (OSV), and various OS-specific feeds.

> **Note:**
> Alauda Container Security includes two scanners: StackRox Scanner and Scanner V4.

The default StackRox Scanner is based on a fork of Clair v2. Since version 4.4, Alauda Container Security also includes Scanner V4, which is built on ClairCore and offers enhanced image scanning capabilities.

> **Note:**
> This documentation uses the term "Alauda Container Security scanner" or "Scanner" to refer to the combined scanning capabilities provided by the two scanners. When referring to the capabilities of a specific scanner, the name of the specific scanner is used.

When vulnerabilities are detected, Alauda Container Security:
- Displays them in the [**Vulnerability Management**](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html/operating/managing-vulnerabilities#common-vuln-management-tasks) view for detailed analysis
- Ranks and highlights them in the portal for risk assessment
- Checks them against enabled [security policies](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html/operating/managing-security-policies#about-security-policies)

The scanner identifies installed components by inspecting specific files within the image. If these files are missing, some components or vulnerabilities may not be detected. The required files include:

| Component Type              | Required Files                                                                                       |
|----------------------------|-----------------------------------------------------------------------------------------------------|
| Package managers           | `/etc/alpine-release`; `/etc/lsb-release`; `/etc/os-release` or `/usr/lib/os-release`; `/etc/oracle-release`; `/etc/centos-release`; `/etc/redhat-release`; `/etc/system-release`; Other similar system files. |
| Language-level dependencies | `package.json` for JavaScript; `dist-info` or `egg-info` for Python; `MANIFEST.MF` in Java Archive (JAR) for Java. |
| Application-level dependencies | `dotnet/shared/Microsoft.AspNetCore.App/`; `dotnet/shared/Microsoft.NETCore.App/` |

Alauda Container Security provides its own scanner, or you can configure an integration to use Alauda Container Security with another vulnerability scanner.

## Scanner V4 Overview

Starting from version 4.4, Scanner V4, built on [ClairCore](https://github.com/quay/claircore), provides scanning for language and operating system-specific image components. Currently, Alauda Container Security also uses the StackRox Scanner. To continue receiving full scanning support with the latest features, usage of both scanners is required.

> **Note:**
> Beginning with release 4.6, due to changes in vulnerability sources used, Scanner V4 only considers vulnerabilities affecting Red Hat products dated back to 2014. Previously, when reading Red Hat's OVAL data, the vulnerabilities dated back to before 2000.

Scanner V4 is not enabled by default, but you can enable Scanner V4 during or after installation. Because the StackRox Scanner provides information about Kubernetes system platform vulnerabilities and non-RHCOS vulnerabilities, you must keep the StackRox scanner enabled to continue receiving reports for that data.

Scanner V4 is enabled in Central and is not required in secured clusters, unless you have specific needs, such as the need to access image registries that are located outside of the cluster and are not accessible from Central. For example, you enable Scanner V4 on secured clusters when using the Alauda Container Platform image registry, or in an Alauda Container Security Cloud Service system that only allows traffic to the registry from within its own firewalls. It is also required when using registry mirroring. For more information, see [Accessing delegated image scanning](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html/operating/examine-images-for-vulnerabilities#accessing-delegated-image-scanning_examine-images-for-vulnerabilities).

### Enabling Scanner V4

You can enable Scanner V4 during or after installation. The following procedures describe how to enable Scanner V4 in different scenarios.

#### On Central
1. In the Operator UI, set **Scanner V4 Component** to **Enabled** or add to the Central CR YAML:
   ```yaml
   scannerV4:
     scannerComponent: Enabled
   ```
2. Configure your init bundle or cluster registration secret (CRS) to allow communication between Central and the secured cluster. For more information, see the relevant documentation.

#### On Secured Clusters
1. In the Operator UI, set **Scanner V4 Component** to **AutoSense** or add to the SecuredCluster CR YAML:
   ```yaml
   scannerV4:
     scannerComponent: AutoSense
   ```
2. Ensure communication with Central is configured.

#### Using Helm
- On Central:
  ```bash
  helm install -n stackrox --create-namespace \
    stackrox-central-services rhacs/central-services \
    --set scannerV4.disable=false \
    -f <path_to_values_public.yaml> -f <path_to_values_private.yaml>
  ```
- On Secured Cluster:
  ```bash
  helm install -n stackrox --create-namespace \
    stackrox-secured-cluster-services rhacs/secured-cluster-services \
    --set-file crs.file=<crs_file_name.yaml> \
    -f <path_to_pull_secret.yaml> \
    -f <path_to_values_public.yaml> -f <path_to_values_private.yaml> \
    --set clusterName=<name_of_the_secured_cluster> \
    --set centralEndpoint=<endpoint_of_central_service> \
    --set scanner.disable=false \
    --set scannerV4.disable=false
  ```

> **Important:**
> Even if you have Scanner V4 enabled, at this time, the StackRox Scanner must still be enabled to provide scanning of RHCOS nodes and platform vulnerabilities such as Alauda Container Platform, Kubernetes, and Istio. Support for that functionality in Scanner V4 is planned for a future release. **Do not disable the StackRox Scanner.**

## StackRox Scanner Workflow

The StackRox Scanner workflow is as follows:
1. Central submits image scanning requests to the StackRox Scanner.
2. The StackRox Scanner pulls the image layers from the relevant registry, checks the images, and identifies installed packages in each layer.
3. It compares the identified packages and programming language-specific dependencies with the vulnerability lists and sends information back to Central.
4. The StackRox Scanner identifies vulnerabilities in:
   - Base image operating system
   - Packages installed by package managers
   - Programming language-specific dependencies
   - Programming runtimes and frameworks

## Scanner V4 Workflow

The Scanner V4 workflow is as follows:
1. Central requests the Scanner V4 Indexer to download and index (analyze) given images.
2. Scanner V4 Indexer pulls image metadata from registries to determine the layers of the image, and downloads each previously unindexed layer.
3. Scanner V4 Indexer requests mapping files from Central that assist the indexing process. Scanner V4 Indexer produces an index report.
4. Central requests that Scanner V4 Matcher match given images to known vulnerabilities. This process results in the final scan result: a vulnerability report. Scanner V4 Matcher requests the latest vulnerabilities from Central.
5. Scanner V4 Matcher requests the results of the image indexing, the index report, from Scanner V4 Indexer. It then uses the report to determine relevant vulnerabilities. This interaction occurs only when the image is indexed in the Central cluster. This interaction does not occur when Scanner V4 is matching vulnerabilities for images indexed in secured clusters.
6. The Indexer stores data in the Scanner V4 DB related to the indexing results to ensure that image layers are only downloaded and indexed once. This prevents unnecessary network traffic and other resource utilization.
7. When secured cluster scanning is enabled, Sensor requests Scanner V4 to index images. Scanner V4 Indexer requests mapping files from Sensor that assist the indexing process unless Central exists in the same namespace. In that case, Central is contacted instead.

When scanning images with Alauda Container Security for Kubernetes, you might see the `CVE DATA MAY BE INACCURATE` warning message. This message appears when the scanner cannot retrieve complete information about the operating system or other packages in the image.

### Common Scanner Warning Messages

Below are some common warning messages and their meanings:

| **Message** | **Description** |
| --- | --- |
| Unable to retrieve the OS CVE data, only Language CVE data is available | Indicates that Scanner does not officially support the base operating system of the image; therefore, it cannot retrieve CVE data for the operating system-level packages. |
| Stale OS CVE data | Indicates that the base operating system of the image has reached end-of-life, which means the vulnerability data is outdated. For example, Debian 8 and 9. |
| Failed to get the base OS information | Indicates that Scanner scanned the image, but was unable to determine the base operating system used for the image. |
| Failed to retrieve metadata from the registry | Indicates that the target registry is unreachable on the network. The cause could be a firewall blocking `docker.io`, or an authentication issue preventing access. |
| Image out of scope for Red Hat Vulnerability Scanner Certification | Indicates that Scanner scanned the image, but the image is old and does not fall within the scope of Red Hat Scanner Certification. |

> **Important:**
> If you are using a Red Hat [container image](https://catalog.redhat.com/software/containers/explore), consider using a base image newer than June 2020.

## Supported Linux Distributions

The following table lists the Linux distributions in which Scanner identifies vulnerabilities. This is different from the supported platforms on which you can install Alauda Container Security for Kubernetes.

| Distribution | Version |
|--------------|---------|
| Alpine Linux | `alpine:3.2`, `alpine:3.3`, `alpine:3.4`, `alpine:3.5`, `alpine:3.6`, `alpine:3.7`, `alpine:3.8`, `alpine:3.9`, `alpine:3.10`, `alpine:3.11`, `alpine:3.12`, `alpine:3.13`, `alpine:3.14`, `alpine:3.15`, `alpine:3.16`, `alpine:3.17`, `alpine:3.18`, `alpine:3.19`, `alpine:3.20`, `alpine:3.21`, `alpine:edge` |
| Amazon Linux | `amzn:2018.03`, `amzn:2`, `amzn:2023` |
| CentOS | `centos:6`, `centos:7`, `centos:8` |
| Debian | `debian:11`, `debian:12`, `debian:unstable`, [`Distroless`](https://github.com/GoogleContainerTools/distroless`) |
| Oracle Linux | `ol:5`, `ol:6`, `ol:7`, `ol:8`, `ol:9` |
| Photon OS | `photon:1.0`, `photon:2.0`, `photon:3.0` |
| Red Hat Enterprise Linux (RHEL) | `rhel:6`, `rhel:7`, `rhel:8`, `rhel:9` |
| SUSE | `sles:11`, `sles:12`, `sles:15`, `opensuse-leap:15.5`, `opensuse-leap:15.6` |
| Ubuntu | `ubuntu:14.04`, `ubuntu:16.04`, `ubuntu:18.04`, `ubuntu:20.04`, `ubuntu:22.04`, `ubuntu:24.04`, `ubuntu:24.10` |

> **Note:**
> - For Debian, the following vulnerability sources are not updated by the vendor: `debian:8`, `debian:9`, `debian:10`.
> - For Ubuntu, the following vulnerability sources are not updated by the vendor: `ubuntu:12.04`, `ubuntu:12.10`, `ubuntu:13.04`, `ubuntu:14.10`, `ubuntu:15.04`, `ubuntu:15.10`, `ubuntu:16.10`, `ubuntu:17.04`, `ubuntu:17.10`, `ubuntu:18.10`, `ubuntu:19.04`, `ubuntu:19.10`, `ubuntu:20.10`, `ubuntu:21.04`, `ubuntu:21.10`, `ubuntu:22.10`, `ubuntu:23.04`, `ubuntu:23.10`.
> - Fedora is not supported for OS CVEs, but language CVEs are detected.

## Supported Package Formats

The following table lists the package formats and their corresponding package managers supported by the scanner:

| Package Format | Package Managers |
|---------------|-----------------|
| apk           | apk             |
| dpkg          | apt, dpkg       |
| rpm           | dnf, microdnf, rpm, yum |

## Supported Programming Languages

The following table lists the programming languages and package formats supported for vulnerability scanning:

| Programming Language | Package Format |
|---------------------|---------------|
| Go                  | Binaries: The standard library version used to build the binary is analyzed. If the binaries are built with module support (`go.mod`), then the dependencies are also analyzed. |
| Java                | JAR, WAR, EAR, JPI, HPI |
| JavaScript          | package.json |
| Python              | egg, wheel |
| Ruby                | gem |

## Supported Container Image Layer Formats

The following table lists the supported container image layer formats:

| Format         | StackRox Scanner Support | Scanner V4 Support |
|---------------|--------------------------|-------------------|
| No compression| Yes                      | Yes               |
| bzip2         | Yes                      | Yes               |
| gzip          | Yes                      | Yes               |
| xz            | Yes                      | No                |
| zstd          | No                       | Yes               |

> **Note:**
> Beginning from Alauda Container Security for Kubernetes 3.0.50 (Scanner version 2.5.0), the StackRox Scanner identifies vulnerabilities in the following developer platforms:
> - .NET Core
> - ASP.NET Core
> These are not supported by Scanner V4.

## Delegated Image Scanning

Alauda Container Security for Kubernetes supports scanning images from registry mirrors that you have configured by using one of the following Alauda Container Platform custom resources (CRs):
- `ImageContentSourcePolicy` (ICSP)
- `ImageDigestMirrorSet` (IDMS)
- `ImageTagMirrorSet` (ITMS)

For more information about how to configure image registry repository mirroring, see "Configuring image registry repository mirroring".

You can automatically scan images from registry mirrors by using delegated image scanning. For more information about how to configure delegated image scanning, see "Scanning images by using secured clusters".

You can have isolated container image registries that are only accessible from your secured clusters. The delegated image scanning feature enables you to scan images from any registry in your secured clusters.

Currently, by default, Central Services Scanner performs both indexing (identification of components) and vulnerability matching (enrichment of components with vulnerability data) for images observed in your secured clusters, with the exception of images from the Alauda Container Platform integrated registry.

For images from the Alauda Container Platform integrated registry, Scanner-slim installed in your secured cluster performs the indexing, and the Central Services Scanner performs the vulnerability matching.

The delegated image scanning feature extends scanning functionality by allowing Scanner-slim to index images from any registry and then send them to Central for vulnerability matching. To use this feature, ensure that Scanner-slim is installed in your secured clusters. If Scanner-slim is not present, scan requests are sent directly to Central.

To scan images by using the secured clusters instead of the Central services, you can use the delegated image scanning feature.

A new delegated scanning configuration specifies the registries from which you can delegate image scans. For images that Sensor observes, you can use the delegated registry configuration to delegate scans from no registries, all registries, or specific registries.

To enable delegation of scans by using the `roxctl` CLI, Jenkins plugin, or API, you must also specify a destination cluster and source registry.

**Prerequisites**
- You have installed Scanner in the secured cluster to scan images.
  > **Note:**
  > Enabling Scanner is supported on Alauda Container Platform and Kubernetes secured clusters.

**Procedure**
1.  In the Alauda Container Security portal, click **Platform Configuration Clusters**.
2.  In the **Clusters** view header, click **Delegated scanning**.
3.  In the **Delegated Image Scanning** page, provide the following information:
    - **Delegate scanning for**: To choose the scope of the image delegation, select one of the following options:
      - **None**: The default option. This option specifies that the secured clusters do _not_ scan any images, except for images from the integrated Alauda Container Platform image registry.
      - **All registries**: This option indicates that the secured clusters scan all the images.
      - **Specified registries**: This option specifies the images that secured clusters should scan based on the registries list.
    - **Select default cluster to delegate to**: From the drop-down list, select the name of the default cluster. The default cluster processes the scan requests coming from the command-line interface (CLI) and API. This is optional and you can select `None` if required.
    - Optional: To specify the source registry and destination cluster details, click **Add registry**.
      For example, specify the source registry as `example.com`, and select `remote` from the drop-down list for the destination cluster. You can add more than one source registry and destination cluster if required.
      > **Important:**
      > You can select the destination cluster as `None` if the scan requests are not coming from the CLI and API.
4.  Click **Save**.

Image integrations are now synchronized between Central and Sensor, and Sensor captures pull secrets from each namespace. Sensor then uses these credentials to authenticate to the image registries.

Alauda Container Security Operator installs a Scanner-slim version on each secured cluster to scan images in the Alauda Container Platform integrated registry and optionally other registries.

For more information, see [Installing Alauda Container Security on secured clusters by using the Operator](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html-single/installing/#installing-sc-operator).

Secured Cluster Services Helm chart (`secured-cluster-services`) installs a Scanner-slim version on each secured cluster. In Kubernetes, the secured cluster services include Scanner-slim. On Alauda Container Platform, however, Alauda Container Security installs a Scanner-slim version on each secured cluster to scan images in the Alauda Container Platform integrated registry and optionally other registries.
- For Alauda Container Platform installations, see [Installing the secured-cluster-services Helm chart without customization](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html-single/installing/#installing-secured-cluster-services-quickly_install-secured-cluster-ocp).
- For non-Alauda Container Platform installations, such as Amazon Elastic Kubernetes Service (Amazon EKS), Google Kubernetes Engine (Google GKE), and Microsoft Azure Kubernetes Service (Microsoft AKS), see [Installing the secured-cluster-services Helm chart without customization](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html-single/installing/#installing-secured-cluster-services-quickly_install-secured-cluster-other).

**Procedure**
- Verify that the status of the secured cluster indicates that Scanner is present and healthy:
  1.  In the Alauda Container Security portal, go to **Platform Configuration Clusters**.
  2.  In the **Clusters** view, select a cluster to view its details.
  3.  In the **Health Status** card, ensure that **Scanner** is present and is marked as **Healthy.**

You can scan images stored in a cluster-specific Alauda Container Platform integrated image registry by using `roxctl` CLI, Jenkins, and API. You can specify the appropriate cluster in the delegated scanning configuration or use the cluster parameter available in `roxctl` CLI, Jenkins, and API.

For more information about how to scan images by using the `roxctl` CLI, see [Image scanning by using the roxctl CLI](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html-single/roxctl_cli/#image-scanning-by-using-the-roxctl-cli).

You can configure settings for scanning, such as automatic scanning of active and inactive images.

Alauda Container Security periodically scans all active images and updates the image scan results to reflect the latest vulnerability definitions. Active images are the images you have deployed in your environment.

> **Note:**
> From Alauda Container Security 3.0.57, you can enable automatic scanning of inactive images by configuring the **Watch** setting for images.

Central fetches the image scan results for all active images from Scanner or other integrated image scanners that you use and updates the results every 4 hours.

You can also use the `roxctl` CLI to check the image scan results on demand.

Alauda Container Security scans all active (deployed) images every 4 hours and updates the image scan results to reflect the latest vulnerability definitions.

You can also configure Alauda Container Security to scan inactive (not deployed) images automatically.

**Procedure**
1.  In the Alauda Container Security portal, click **Vulnerability Management** **Results**.
2.  Click **More Views** **Inactive images**.
3.  Click **Manage watched images**.
4.  In the **Image name** field, enter the fully-qualified image name that begins with the registry and ends with the image tag, for example, `docker.io/library/nginx:latest`.
5.  Click **Add image to watch list**.
6.  Optional: To remove a watched image, locate the image in the **Manage watched images** window, and click **Remove watch**.
    > **Important:**
    > In the Alauda Container Security portal, click **Platform Configuration** **System Configuration** to view the data retention configuration.
    > All the data related to the image removed from the watched image list continues to appear in the Alauda Container Security portal for the number of days mentioned on the **System Configuration** page and is only removed after that period is over.
7.  Click **Close** to return to the **Inactive images** page.

Alauda Container Security fetches vulnerability definitions and updates from multiple vulnerability feeds. These feeds are both general in nature, such as NVD, or distribution-specific, such as Alpine, Debian, and Ubuntu. For more information on viewing and addressing vulnerabilities that are found, see [Vulnerability management](https://docs.redhat.com/en/documentation/red_hat_advanced_cluster_security_for_kubernetes/4.7/html/operating/managing-vulnerabilities#vulnerability-management).

In online mode, Central fetches the vulnerability definitions every 5 minutes from a single feed. This feed combines vulnerability definitions from upstream sources, and it refreshes every 3 hours. The address of the feed is `https://definitions.stackrox.io`.

You can change the frequency of the default query from Central to the `definitions.stackrox.io` feed by setting the `ROX_SCANNER_VULN_UPDATE_INTERVAL` environment variable. Run the following command:

```bash
$ oc -n stackrox set env deploy/central ROX_SCANNER_VULN_UPDATE_INTERVAL=<value>
```
If you use Kubernetes, enter `kubectl` instead of `oc`.

This variable applies to the connection between Central and the `definitions.stackrox.io` feed. Both the StackRox Scanner and Scanner V4 use vulnerability data from Central that is obtained from this feed. The StackRox Scanner's config map still has an `updater.interval` parameter for configuring the scanner's updating frequency, but it no longer includes the `fetchFromCentral` parameter.

For more information about the vulnerability sources that Alauda Container Security uses, see "Vulnerability sources" in "Alauda Container Security architecture".

The vulnerability management dashboard in the Alauda Container Security portal shows a single Common Vulnerability Scoring System (CVSS) base score for each vulnerability. Alauda Container Security shows the CVSS score based on the following criteria:
- If a CVSS v3 score is available, Alauda Container Security shows the score and lists `v3` along with it. For example, `6.5 (v3)`.
  > **Note:**
  > CVSS v3 scores are only available if you are using the StackRox Scanner version 1.3.5 and later or Scanner V4.
- If a CVSS v3 score is not available, Alauda Container Security might show only the CVSS v2 score. For example, `6.5`.

You can use the API to get the CVSS scores. If CVSS v3 information is available for a vulnerability, the response might include both CVSS v3 and CVSS v2 information.

For a Red Hat Security Advisory (RHSA), the CVSS score is set to the highest CVSS score among all the related CVEs. One RHSA can contain multiple CVEs, and Red Hat sometimes assigns a different score based on how a vulnerability affects other Red Hat products.

Scanner identifies the vulnerabilities in the programming language-specific dependencies by default. You can disable the language-specific dependency scanning.

**Procedure**
- To disable language-specific vulnerability scanning, run the following command:

  ```bash
  $ oc -n stackrox set env deploy/scanner ROX_LANGUAGE_VULNS=false
  ```
  If you use Kubernetes, enter `kubectl` instead of `oc`.
  If you are using Alauda Container Security for Kubernetes version 3.0.47 or older, replace the environment variable name `ROX_LANGUAGE_VULNS` with `LANGUAGE_VULNS`.

- [Red Hat CVE Database](https://access.redhat.com/security/cve)
